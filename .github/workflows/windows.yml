name: windows
on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v1
      - uses: actions/checkout@v1
        with:
          repository: 'sbcl/sbcl'
          ref: 'sbcl-2.4.0'
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: mingw-w64-ucrt-x86_64-toolchain make diffutils git cmake
      - name: install host sbcl
        shell: pwsh
        working-directory: ..\sbcl
        run: |
          choco install sbcl -source tools-for-build
      - name: build sbcl and libsbcl
        env:
          SBCL_HOME: "/c/Program Files/Steel Bank Common Lisp/1.4.14"
        working-directory: ..\sbcl
        run: |
          PATH=$PATH:"/c/Program Files/Steel Bank Common Lisp/1.4.14"
          export PATH
          ./make.sh --xc-host='sbcl --lose-on-corruption --disable-ldb --disable-debugger'
          ./make-shared-library.sh
          mv src/runtime/libsbcl.so src/runtime/libsbcl.dll
      - name: install quicklisp
        run: |
          curl -O https://beta.quicklisp.org/quicklisp.lisp
          ../sbcl/run-sbcl.sh --load quicklisp.lisp --eval "(quicklisp-quickstart:install)" --eval "(ql-util:without-prompting (ql:add-to-init-file))" --eval "(quit)"
      - name: build example
        working-directory: examples/smart-libraries
        run: |
          mkdir build
          ../../../sbcl/run-sbcl.sh --dynamic-space-size 8192 --load generate-libbase.lisp
          ../../../sbcl/run-sbcl.sh --dynamic-space-size 8192 --load generate.lisp
