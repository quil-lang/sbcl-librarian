name: windows
on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v1
        with:
          repository: 'sbcl/sbcl'
          ref: 'sbcl-2.2.4'
      - uses: msys2/setup-msys2@v2
        with:
          install: mingw-w64-x86_64-gcc make diffutils git cmake
      - name: install host sbcl
        shell: pwsh
        run: |
          choco install sbcl -source tools-for-build
      - name: build sbcl and libsbcl
        env:
          SBCL_HOME: "/c/Program Files/Steel Bank Common Lisp/1.4.14"
        run: |
          PATH=$PATH:"/c/Program Files/Steel Bank Common Lisp/1.4.14"
          export PATH
          ./make.sh --xc-host='sbcl --lose-on-corruption --disable-ldb --disable-debugger'
          ./make-shared-library.sh
          mv src/runtime/libsbcl.so src/runtime/libsbcl.dll
      - uses: actions/checkout@v1
      - name: build example
        run:
          ls